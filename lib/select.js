"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}var turboClass=require("./turbo"),Select=function(){function a(){_classCallCheck(this,a);var b=require("./turbo");this.turbo=new b}return _createClass(a,[{key:"initSelects",value:function initSelects(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:document,b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],c=a.querySelectorAll(".turbo-ui.select");if(c)for(var f=0;f<c.length;f++){var d=c[f],e=d.querySelector("select");if(e){var g="turbo-select-".concat(f+1);this.makeCustomSelect(d,g,b),this.bindOpenOptions(d)}}}},{key:"makeCustomSelect",value:function makeCustomSelect(a,b,c){var d=a.querySelector("select"),e=a.querySelector("label"),f=d.classList.contains("searchable"),g=Array.from(d.options),h=this.turbo.createElement("div",null,{class:["turbo-select"],id:b}),j=this.turbo.createElement("div",null,{class:["options-wrapper"]}),k=["label"];f&&k.push("search");var l=this.turbo.createElement("span",f?null:e.textContent,{class:k,dataset:{default:e.textContent}});if(f){var x=this.turbo.createElement("input",null,{placeholder:e.textContent,id:"options-search",autocomplete:"off"});this.turbo.showElement(x,l,"append","block",{})}for(var m=this.turbo.createElement("div",null,{class:["options"]}),n=[],o=0;o<g.length;o++){var p=g[o],q=!1;if(p.hasAttribute("disabled")&&(q=!0),p){var r=p.textContent,s=p.value,t=[],u={dataset:{value:s}};if(q){if(this.turbo.settings.select.hideDisabledOptions)continue;t.push("disabled"),u["class"]=t}var y=this.turbo.createElement("span",r,u);n.push({text:r,value:s,attributes:{class:t}}),this.turbo.showElement(y,m,"append","block",{})}}for(var v=this.turbo.createElement("div",null,{class:["dropdown-arrow"]}),w=0;2>w;w++)this.turbo.showElement(this.turbo.createElement("span",null,{class:["arrow-part"]}),v,"append","block",{});this.turbo.showElement(l,j,"prepend","block",{}),this.turbo.showElement(m,j,"append","none",{}),this.turbo.showElement(j,h,"append","flex",{}),this.turbo.showElement(v,h,"append","flex",{}),this.turbo.showElement(h,a,"append","flex",{}),this.setDefaultOptions(n,b,c)}},{key:"setDefaultOptions",value:function setDefaultOptions(a,b,c){var d=sessionStorage.getItem("turbo-select");d&&sessionStorage.setItem("turbo-select",JSON.stringify({}));var e=JSON.parse(d),f={};if(!c)for(var g in e)f[g]=e[g];f[b]=a,sessionStorage.setItem("turbo-select",JSON.stringify(f))}},{key:"getDefaultOptions",value:function getDefaultOptions(a){var b,c=sessionStorage.getItem("turbo-select");return c=JSON.parse(c),null!==(b=c[a])&&void 0!==b?b:[]}},{key:"bindOpenOptions",value:function bindOpenOptions(a){var b=this;a.querySelector(".turbo-select")&&(a.querySelector(".turbo-select .options-wrapper").addEventListener("click",function(a){var c=a.target.closest(".turbo-ui .turbo-select");if(a.stopPropagation(),"DIV"===a.target.nodeName||"INPUT"===a.target.nodeName)b.toggleOptions(a,c);else{var d=a.target.classList.contains("disabled");d||b.closeOptions(c.querySelector(".options"),a.target)}}),a.querySelector(".turbo-select .dropdown-arrow").addEventListener("click",function(a){b.toggleOptions(a,a.target.closest(".turbo-ui .turbo-select")),a.stopPropagation()}))}},{key:"toggleOptions",value:function toggleOptions(a,b){var c=b.querySelector(".options"),d=b.closest(".turbo-ui.select"),e=d.querySelector("select").classList.contains("searchable"),f=c.classList,g=!f.contains("opened");if(g)this.openOptions(c);else{var h=c.querySelectorAll("span"),j=null,k="";if(e&&this.turbo.getData(b,"selected")||1===h.length&&this.turbo.getData(h[0],"value")===this.turbo.settings.select.notFoundOptionValue)return void(a.target.classList.contains("dropdown-arrow")&&this.closeOptions(c,this.findSelected(c,!0)));for(var l,m=0;m<h.length;m++)l=h[m],l.classList.contains("active")&&(j=l,k=l.textContent);e&&!this.turbo.isEmpty(k)&&(b.querySelector("input#options-search").value=k),this.closeOptions(c,j)}}},{key:"openOptions",value:function openOptions(a){var b=a.closest(".turbo-ui.select"),c=b.querySelector("select").classList.contains("searchable");if(c){var d=a.closest(".options-wrapper").querySelector(".label"),e=d.querySelector("#options-search"),f=e.value,g=this.findSelected(a);this.turbo.isEmpty(f)||(e.value="",e.setAttribute("placeholder",f)),d.classList.remove("selected"),this.filterOptions(e,e.value,g)}this.turbo.toggleAnimationClass(a,"animation-slide-in-top",150),a.style.display="block",a.classList.add("opened");var h=this;document.addEventListener("click",function b(){var d=require("./turbo"),e=new d,f=null;if(a.classList.contains("opened")&&c){var g=a.closest(".turbo-select"),j=a.closest(".options-wrapper").querySelector("span.label"),k=j.querySelector("#options-search"),l=a.querySelectorAll("span"),m=e.getData(g,"selected");if(!m){var n=h.getDefaultOptions(a.closest(".turbo-select").id),o=h.selectFilter(k.value.toLowerCase(),n,!0);if(!e.isEmpty(o))return h.selectFirstOption(a,!0);var p=e.getData(j,"default");k.value="",k.setAttribute("placeholder",p),k.closest(".label").classList.remove("selected")}h.resetOptions(g),l=a.querySelectorAll("span");for(var q,r=0;r<l.length;r++)if(q=l[r],!e.isEmpty(m)&&e.getData(q,"value")===m){f=q;break}}h.closeOptions(a,f),document.removeEventListener("click",b)})}},{key:"closeOptions",value:function closeOptions(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,c=a.closest(".turbo-ui.select").querySelector("select"),d=c.classList.contains("searchable"),e=a.closest(".options-wrapper").querySelector(".label"),f=a.closest(".turbo-select");if(d&&(this.resetOptions(f,b),!b&&(b=this.findSelected(a,!0))),b){var g=this.turbo.getData(b,"value"),h=b.textContent;if(d){var m=e.querySelector("#options-search");m.value=h,m.setAttribute("placeholder",h)}else e.textContent=h;for(var j,k=a.querySelectorAll("span"),l=0;l<k.length;l++)j=k[l],j.classList.remove("active");e.classList.add("selected"),a.querySelector("span[data-value=\"".concat(this.turbo.getData(b,"value"),"\"]")).classList.add("active"),c.value=g,f.dataset.selected=g}this.turbo.toggleAnimationClass(a,"animation-slide-out-top",150),setTimeout(function(){a.style.display="none"},150),a.classList.remove("opened")}},{key:"resetOptions",value:function resetOptions(a){for(var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,c=a.querySelector(".options"),d=c.querySelectorAll("span"),e=0;e<d.length;e++)d[e].remove();var f=this.getDefaultOptions(a.getAttribute("id"));this.showFilteredOptions(c,f,b,!1)}},{key:"findSelected",value:function findSelected(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];a=a.querySelectorAll("span");for(var c,d=0;d<a.length;d++)if(c=a[d],c.classList.contains("active"))return b?c:this.turbo.getData(c,"value");return null}},{key:"filterOptions",value:function filterOptions(a,b){var c=this,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,e=a.closest(".turbo-select").id,f=a.closest(".options-wrapper").querySelector(".options"),g=this.getDefaultOptions(e);""===b&&this.showFilteredOptions(f,g,d),a.addEventListener("input",function(){var b=a.value.toLowerCase(),e=c.selectFilter(b,g);""===b?a.closest(".label").classList.remove("selected"):a.closest(".label").classList.add("selected"),c.showFilteredOptions(f,e,d)})}},{key:"selectFilter",value:function selectFilter(a,b){var c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],d=[];if(c&&""===a)return d;for(var k=0;k<b.length;k++){var e=b[k].value,f=b[k].text,g=f.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),h=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),j={value:e,text:f,attributes:b[k].attributes};-1<g.indexOf(a)&&(d[k]=j),this.turbo.settings.select.searchAlsoValue&&-1<h.indexOf(a)&&this.turbo.isEmpty(d[k])&&(d[k]=j)}return d.filter(function(a){return void 0!==a})}},{key:"showFilteredOptions",value:function showFilteredOptions(a,b){for(var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,d=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],e=a.querySelectorAll("span"),f=0;f<e.length;f++)e[f].remove();if(this.turbo.isEmpty(b)){var l=this.turbo.createElement("span",this.turbo.settings.text.notFound,{dataset:{value:this.turbo.settings.select.notFoundOptionValue}});this.turbo.showElement(l,a,"append","block",{})}else for(var m=0;m<b.length;m++){var g,h=b[m],j=null===(g=h.attributes)||void 0===g?void 0:g["class"].includes("disabled"),k=!1;if(j){if(this.turbo.settings.select.hideDisabledOptions)continue;k=!0}var n={dataset:{value:h.value}};k&&(n["class"]=["disabled"]),c&&h.value===c&&(n["class"]=["active"]);var o=this.turbo.createElement("span",this.turbo.capitalizeFirstLetter(h.text),n);this.turbo.showElement(o,a,"append",d?"block":"none",{})}}},{key:"selectFirstOption",value:function selectFirstOption(a,b){var c=a.querySelectorAll("span")[0];b&&this.closeOptions(a,c)}}]),a}();module.exports=Select;